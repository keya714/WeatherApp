<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Weather Pro</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    /* --- minimal styles for edit dialog --- */
    dialog#editDialog { width: 640px; max-width: 95vw; border-radius: 16px; border: 1px solid var(--border); background: var(--card); color: var(--text); }
    .dlg-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .dlg-grid { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .dlg-grid .full { grid-column: 1 / -1; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .dlg-actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 14px; }
    .readonly input { background:#0b121b; opacity:.9 }
    .err-inline { margin-top:8px; background:#1a0b0b; border:1px solid #482b2b; color:#ffb4b4; padding:8px 10px; border-radius:10px; display:none; }
  </style>
</head>
<body>
<header class="app-header">
  <div class="brand">
    <span class="logo">‚õÖ</span>
    <div>
      <h1>AI Weather Pro</h1>
      <p class="subtitle">CRUD + Export Demo</p>
    </div>
  </div>
  <div class="actions">
    <button id="infoBtn" class="btn ghost" title="About">‚ÑπÔ∏è Info</button>
    <dialog id="infoDialog">
      <h3>About PM Accelerator</h3>
      <p>
        Learn more on LinkedIn: 
        <a href="https://www.linkedin.com/company/product-manager-accelerator/" target="_blank" rel="noopener">Product Manager Accelerator</a>
      </p>
      <p>Built by: <strong>Keya Gohil</strong></p>
      <form method="dialog">
        <button class="btn">Close</button>
      </form>
    </dialog>
  </div>
</header>

<main class="container">
  <section class="card">
    <h2>Find Weather</h2>
    <fieldset class="mode-cards" role="radiogroup" aria-label="Input Type">
      <label class="radio-card" tabindex="0">
        <input type="radio" name="inputMode" value="name" checked />
        <div class="icon">üìç</div><div class="title">Place</div>
        <div class="hint">City / landmark (e.g., ‚ÄúAustin, TX‚Äù)</div>
      </label>
      <label class="radio-card" tabindex="0">
        <input type="radio" name="inputMode" value="coords" />
        <div class="icon">üß≠</div><div class="title">Coordinates</div>
        <div class="hint">lat,lon (e.g., 30.2672,-97.7431)</div>
      </label>
      <label class="radio-card" tabindex="0">
        <input type="radio" name="inputMode" value="ip" />
        <div class="icon">üåê</div><div class="title">My IP</div>
        <div class="hint">Autodetect via IP</div>
      </label>
    </fieldset>

    <form id="queryForm" class="grid">
      <div class="field" data-for="name">
        <label for="placeName">Place</label>
        <input id="placeName" type="text" placeholder="e.g., Austin, TX" />
      </div>
      <div class="field" data-for="coords" hidden>
        <label for="coords">Coordinates</label>
        <input id="coords" type="text" placeholder="lat,lon (e.g., 30.2672,-97.7431)" />
      </div>
      <div class="row">
        <button id="submitBtn" type="submit" class="btn" disabled>Get Weather</button>
        <button id="saveBtn" type="button" class="btn accent" disabled>Save (CREATE)</button>
      </div>
      <p class="muted">Submit is enabled only when required inputs are valid for the selected mode.</p>
      <div id="formError" class="error" hidden></div>
    </form>
  </section>

  <section >
    <article class="card" id="aiCard" hidden>
      <h3>AI Clothing & Prep</h3>
      <div id="aiMeta" class="ai-meta muted"></div>
      <pre id="aiAdvice" class="ai-advice"></pre>
    </article>
  </section>

  <section class="grid two">
    <article class="card">
      <h3>Current Weather</h3>
      <div id="currentWeather" class="weather-panel empty"><p class="muted">No data yet.</p></div>
    </article>
    <article class="card">
      <h3>Forecast</h3>
      <div id="forecast" class="forecast-grid empty"><p class="muted">No data yet.</p></div>
    </article>
  </section>

  <section class="card">
    <div class="row">
      <h2>Saved Records</h2>
      <button id="refreshRecords" class="btn ghost" style="align-items: end;">Refresh</button>
      <button data-export="json" class="btn">JSON</button>
        <button data-export="csv" class="btn">CSV</button>
        <button data-export="xml" class="btn">XML</button>
        <button data-export="markdown" class="btn">Markdown</button>
        <button data-export="pdf" class="btn"  style="align-items: end;">PDF</button>
    </div>
    <div id="recordsWrap" class="table-wrap">
      <table id="recordsTable">
        <thead><tr>
          <th>ID</th><th>Location</th><th>Mode</th><th>Created</th><th>Summary</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="recordsError" class="error" hidden></div>
  </section>

  

</main>

<footer class="footer">
  <small>¬© <span id="year"></span> AI Weather Pro</small>
</footer>

<!-- ===== Edit Dialog ===== -->
<dialog id="editDialog">
  <div class="dlg-header">
    <h3>Edit Record</h3>
    <form method="dialog"><button class="btn ghost">‚úï</button></form>
  </div>

  <form id="editForm" class="dlg-grid">
    <!-- Row 1 -->
    <div class="field">
      <label for="editId">ID</label>
      <input id="editId" type="text" readonly />
      <div class="hint">Record identifier (read-only)</div>
    </div>
    <div class="field">
      <label for="editCreated">Created</label>
      <input id="editCreated" type="text" readonly />
      <div class="hint">Creation timestamp (read-only)</div>
    </div>

    <!-- Row 2 -->
    <div class="field">
      <label for="editMode">Mode</label>
      <select id="editMode">
        <option value="name">Place</option>
        <option value="coords">Coordinates</option>
        <option value="ip">IP</option>
      </select>
      <div class="hint">Input mode to use for this record</div>
    </div>
    <div class="field readonly">
      <label for="editLocation">Location (display)</label>
      <input id="editLocation" type="text" readonly />
      <div class="hint">Computed from your selection (auto)</div>
    </div>

    <!-- Row 3 -->
    <div class="field" id="editPlaceWrap">
      <label for="editPlace">Place</label>
      <input id="editPlace" type="text" placeholder="e.g., Austin, TX or Eiffel Tower" />
      <div class="hint">Required when Mode = Place</div>
    </div>
    <div class="field" id="editCoordsWrap">
      <label for="editCoords">Coordinates</label>
      <input id="editCoords" type="text" placeholder="lat,lon (e.g., 30.2672,-97.7431)" />
      <div class="hint">Required when Mode = Coordinates</div>
    </div>

    <!-- Row 4 -->
    <div class="field full readonly">
      <label for="editSummary">Summary</label>
      <input id="editSummary" type="text" readonly />
      <div class="hint">Updated after save (auto)</div>
    </div>

    <div id="editErr" class="err-inline"></div>

    <div class="dlg-actions full">
      <button type="button" id="editCancel" class="btn ghost">Cancel</button>
      <button type="submit" id="editSave" class="btn">Save</button>
    </div>
  </form>
</dialog>

<script>
const API_BASE = "";
document.getElementById('year').textContent = new Date().getFullYear();

/* Elements */
const infoBtn = document.getElementById('infoBtn');
const infoDialog = document.getElementById('infoDialog');
const form = document.getElementById('queryForm');
const modeCards = Array.from(document.querySelectorAll('.radio-card input'));
const placeField = document.querySelector('[data-for="name"]');
const coordsField = document.querySelector('[data-for="coords"]');
const placeInput = document.getElementById('placeName');
const coordsInput = document.getElementById('coords');
const submitBtn = document.getElementById('submitBtn');
const saveBtn = document.getElementById('saveBtn');
const formError = document.getElementById('formError');
const currentWrap = document.getElementById('currentWeather');
const forecastWrap = document.getElementById('forecast');
const recordsTableBody = document.querySelector('#recordsTable tbody');
const recordsError = document.getElementById('recordsError');
const refreshRecords = document.getElementById('refreshRecords');

/* Edit dialog elements */
const editDialog = document.getElementById('editDialog');
const editForm = document.getElementById('editForm');
const editId = document.getElementById('editId');
const editCreated = document.getElementById('editCreated');
const editMode = document.getElementById('editMode');
const editLocation = document.getElementById('editLocation');
const editPlace = document.getElementById('editPlace');
const editCoords = document.getElementById('editCoords');
const editPlaceWrap = document.getElementById('editPlaceWrap');
const editCoordsWrap = document.getElementById('editCoordsWrap');
const editErr = document.getElementById('editErr');
const editCancel = document.getElementById('editCancel');

let currentEditId = null;

/* Helpers */
function show(el, flag=true){ el.hidden = !flag; }
function showInlineError(el, msg){ el.textContent = msg; el.style.display = msg ? 'block' : 'none'; }
function err(el, msg){ el.textContent = msg; show(el,true); setTimeout(()=>show(el,false),5000); }
function parseCoords(raw){
  const m = /^\s*(-?\d+(?:\.\d+)?)\s*,\s*(-?\d+(?:\.\d+)?)\s*$/.exec(raw||"");
  if(!m) return null;
  const lat=+m[1], lon=+m[2];
  if(lat<-90||lat>90||lon<-180||lon>180) return null;
  return {lat,lon};
}
function currentMode(){ return modeCards.find(r=>r.checked).value; }
function applyModeUI(){
  const m = currentMode();
  placeField.hidden = m!=='name';
  coordsField.hidden = m!=='coords';
  validateForm();
}
modeCards.forEach(r=>r.addEventListener('change', applyModeUI));
infoBtn.onclick = () => infoDialog.showModal();

/* Validation for main form */
function validateForm(){
  const m = currentMode();
  let ok = true;
  if(m==='name') ok = !!placeInput.value.trim();
  if(m==='coords') ok = !!parseCoords(coordsInput.value);
  submitBtn.disabled = saveBtn.disabled = !ok;
}
['input','change'].forEach(evt=>{
  placeInput.addEventListener(evt, validateForm);
  coordsInput.addEventListener(evt, validateForm);
});
applyModeUI();

/* API */
async function api(path, opts={}){
  const res = await fetch(`${API_BASE}${path}`, { ...opts, headers: {'Content-Type':'application/json', ...(opts.headers||{})} });
  if(!res.ok) throw new Error((await res.text()) || res.statusText);
  const ct = res.headers.get('content-type')||'';
  return ct.includes('application/json') ? res.json() : res.text();
}

/* Build payload for weather/records */
function buildPayloadFromMode(mode, placeVal, coordsVal){
  const payload = { input_mode: mode };
  if(mode==='name'){
    if(!placeVal || !placeVal.trim()) throw new Error('Place is required for Mode=Place.');
    payload.place = placeVal.trim();
  } else if(mode==='coords'){
    const c = parseCoords(coordsVal);
    if(!c) throw new Error('Coordinates must be valid "lat,lon".');
    payload.coords = c;
  } // ip ‚Üí no extra fields
  return payload;
}
function buildPayload(){ return buildPayloadFromMode(currentMode(), placeInput.value, coordsInput.value); }

/* Renderers */
function iconFor(code){ const m={clear:'‚òÄÔ∏è','partly-cloudy':'‚õÖ',cloudy:'‚òÅÔ∏è',rain:'üåßÔ∏è',thunder:'‚õàÔ∏è',snow:'‚ùÑÔ∏è',fog:'üå´Ô∏è',wind:'üå¨Ô∏è',drizzle:'üå¶Ô∏è'}; return m[code]||'‚õÖ'; }
function renderCurrent(d){
  currentWrap.innerHTML = `
    <div class="big">${iconFor(d.condition_code)} ${Math.round(d.temp_c)}¬∞C</div>
    <div>${d.location}</div>
    <div>${d.condition_text}</div>
    <div>Humidity: ${d.humidity}%</div>
    <div>Wind: ${d.wind_kph} kph</div>`;
}
// Replaces the simple list version
function renderForecast(days) {
  const arr = Array.isArray(days) ? days : [];
  // Update heading to reflect actual count (WeatherAPI free often returns 3)
  const forecastCardHeading = document.querySelector('article.card h3:nth-of-type(2)') 
                           || document.querySelectorAll('article.card h3')[1];
  if (forecastCardHeading) {
    forecastCardHeading.textContent = `${arr.length}-Day Forecast`;
  }

  if (!arr.length) {
    forecastWrap.classList.add('empty');
    forecastWrap.innerHTML = `<p class="muted">No forecast available.</p>`;
    return;
  }

  forecastWrap.classList.remove('empty');
  forecastWrap.innerHTML = arr.map(d => {
    // nice date label (e.g., "Fri Oct 17 2025")
    const dateLabel = new Date(d.date + 'T00:00:00').toLocaleDateString(undefined, {
      weekday: 'short', month: 'short', day: 'numeric'
    });

    const icon = iconFor(d.condition_code);
    const max = Math.round(d.max_c);
    const min = Math.round(d.min_c);
    const precip = (d.precip_mm ?? 0);
    const wind = (d.wind_kph ?? 0);

    return `
      <div class="forecast-card">
        <div class="fc-date">${dateLabel}</div>
        <div class="fc-icon">${icon}</div>
        <div class="fc-temp"><span class="t-max">${max}¬∞</span> / <span class="t-min">${min}¬∞</span></div>
        <div class="fc-cond">${d.condition_text || ''}</div>
        <div class="fc-meta">
          <span class="pill">üíß ${precip} mm</span>
          <span class="pill">üí® ${wind} kph</span>
        </div>
      </div>
    `;
  }).join('');
}


/* CRUD table helpers */
function rowHtml(r){
  return `<td>${r.id}</td>
  <td>${r.location_display||'-'}</td>
  <td>${r.input_mode}</td>
  <td>${new Date(r.created_at).toLocaleString()}</td>
  <td>${(r.weather&&r.weather.summary)?r.weather.summary:'-'}</td>
  <td class="actions">
    <button class="btn xs ghost" data-edit="${r.id}">Edit</button>
    <button class="btn xs danger" data-del="${r.id}">Delete</button>
  </td>`;
}
function upsertRow(r){
  let tr = recordsTableBody.querySelector(`tr[data-id="${r.id}"]`);
  if(!tr){ tr = document.createElement('tr'); tr.dataset.id = r.id; recordsTableBody.prepend(tr); }
  tr.innerHTML = rowHtml(r);
}
function removeRow(id){ const tr = recordsTableBody.querySelector(`tr[data-id="${id}"]`); if(tr) tr.remove(); }
async function listRecords(){
  try{
    const d = await api('/api/records');
    recordsTableBody.innerHTML = (d||[]).map(r=>`<tr data-id="${r.id}">${rowHtml(r)}</tr>`).join('');
  }catch(ex){ err(recordsError, ex.message||'Failed to load'); }
}

function renderAI(cur) {
  const card = document.getElementById('aiCard');
  const meta = document.getElementById('aiMeta');
  const advice = document.getElementById('aiAdvice');
  // Advice
  console.log('AI Advice:', cur.ai_advice);
  if (cur.ai_advice && String(cur.ai_advice).trim()) {
    advice.textContent = cur.ai_advice.trim();
    card.hidden = false;
  } else {
    advice.textContent = "AI tip: add a GEMINI_API_KEY in your .env to enable suggestions.";
    card.hidden = false; // show the card with hint (optional: set to true to hide instead)
  }
}


/* Weather submit */
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); formError.hidden=true;
  try{
    const p = buildPayload();
    const cur = await api('/api/weather/current',{method:'POST', body:JSON.stringify(p)});
    renderCurrent(cur);
    renderAI(cur);
    const fc = await api('/api/weather/forecast',{method:'POST', body:JSON.stringify(p)});
    renderForecast(fc);
  }catch(ex){ err(formError, ex.message||'Failed'); }
});

/* Create/Update from main form (kept as before) */
saveBtn.addEventListener('click', async ()=>{
  formError.hidden = true;
  try{
    const payload = buildPayload();
    if(currentEditId){
      const up = await api(`/api/records/${encodeURIComponent(currentEditId)}`, { method:'PUT', body:JSON.stringify(payload) });
      upsertRow(up); alert(`Updated ${up.id}`); currentEditId=null; saveBtn.textContent='Save (CREATE)';
    }else{
      const saved = await api('/api/records', { method:'POST', body:JSON.stringify(payload) });
      upsertRow(saved); alert(`Saved ${saved.id}`);
    }
  }catch(ex){ err(formError, ex.message||'Save failed'); }
});

/* Export buttons */
document.querySelectorAll('[data-export]').forEach(b=>b.onclick=async()=>{
  const fmt=b.dataset.export;
  try{
    const res=await fetch(`/api/export?format=${fmt}`); if(!res.ok) throw new Error(await res.text());
    const blob=await res.blob(); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`weather_export.${fmt==='markdown'?'md':fmt}`; a.click();
    URL.revokeObjectURL(url);
  }catch(ex){ err(document.getElementById('exportError'), ex.message||'Export failed'); }
});

/* ===== Row-level Edit/Delete with modal ===== */
recordsTableBody.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const delId = btn.dataset.del, editId = btn.dataset.edit;
  if(delId){
    if(!confirm('Delete this record?')) return;
    try{ await api(`/api/records/${encodeURIComponent(delId)}`, {method:'DELETE'}); removeRow(delId); }
    catch(ex){ err(recordsError, ex.message||'Delete failed'); }
    return;
  }
  if(editId){
    try{
      const rec = await api(`/api/records/${encodeURIComponent(editId)}`);
      openEditDialog(rec);
    }catch(ex){ err(recordsError, ex.message||'Load failed'); }
  }
});

/* ===== Edit dialog logic ===== */
function openEditDialog(rec){
  // populate fields
  editId.value = rec.id || '';
  editCreated.value = rec.created_at ? new Date(rec.created_at).toLocaleString() : '';
  editMode.value = rec.input_mode || 'name';
  editLocation.value = rec.location_display || '';
  editPlace.value = rec.place || '';
  const c = rec.coords || {};
  editCoords.value = (typeof c.lat==='number' && typeof c.lon==='number') ? `${c.lat},${c.lon}` : '';

  // toggle input wrappers
  applyEditModeUI();

  showInlineError(editErr, '');
  editDialog.showModal();
}

function applyEditModeUI(){
  const m = editMode.value;
  if(m === 'name'){
    editPlaceWrap.style.display = '';
    editCoordsWrap.style.display = 'none';
  } else if(m === 'coords'){
    editPlaceWrap.style.display = 'none';
    editCoordsWrap.style.display = '';
  } else {
    editPlaceWrap.style.display = 'none';
    editCoordsWrap.style.display = 'none';
  }
}
editMode.addEventListener('change', applyEditModeUI);

editCancel.addEventListener('click', ()=> editDialog.close());

editForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  showInlineError(editErr, '');

  try{
    // Validate & build payload from dialog fields
    const payload = buildPayloadFromMode(editMode.value, editPlace.value, editCoords.value);

    // PUT update
    const id = editId.value;
    const updated = await api(`/api/records/${encodeURIComponent(id)}`, {
      method:'PUT',
      body: JSON.stringify(payload)
    });

    // reflect changes in table and close
    upsertRow(updated);
    editDialog.close();

  }catch(ex){
    showInlineError(editErr, ex.message || 'Update failed');
  }
});

/* Init */
refreshRecords.addEventListener('click', listRecords);
listRecords();
</script>
</body>
</html>
